# D01-04: ICMP, Testing и Troubleshooting

## Цел на лекцията
Използване на различни инструменти за тестване на мрежова свързаност

---

## 1. ICMP Съобщения

### Какво е ICMP?
**Internet Control Message Protocol (ICMP)** е протокол за съобщения за грешки и информационни съобщения в IP мрежите. ICMP не прави IP надежден, но предоставя обратна връзка за проблеми при обработката на IP пакети.

**Важно:** ICMP съобщенията не са задължителни и често са блокирани от firewall-и по причини за сигурност.

### Типове ICMP съобщения

#### Host Reachability (Достъпност на хост)
- **ICMP Echo Request** – локалният хост изпраща заявка към отдалечен хост
- **ICMP Echo Reply** – ако хостът е достъпен, той отговаря
- **Използва се от:** командата `ping`

**Как ping използва ICMP:**
Когато изпълните `ping 192.168.1.1`, операционната система генерира ICMP Echo Request пакет и го изпраща към посочения адрес. Ако хостът е достъпен и отговаря, изпраща обратно ICMP Echo Reply пакет. Времето между изпращането и получаването на отговор се измерва и показва като RTT (Round Trip Time).

#### Destination Unreachable (Недостъпна дестинация)
Когато пакет не може да бъде доставен, се изпраща ICMP Destination Unreachable съобщение с код, указващ причината.

**ICMPv4 кодове:**
- `0` - Мрежата е недостъпна
- `1` - Хостът е недостъпен
- `2` - Протоколът е недостъпен
- `3` - Портът е недостъпен

**ICMPv6 кодове:**
- `0` - Няма маршрут до дестинацията
- `1` - Комуникацията е административно забранена (firewall)
- `2` - Извън обхвата на source адреса
- `3` - Адресът е недостъпен
- `4` - Портът е недостъпен

#### Time to Live (TTL) - обяснение

**Time to Live (TTL)** е поле в IPv4 заглавката, което определя максималния брой рутери (hops), през които един пакет може да премине, преди да бъде изхвърлен. Целта на TTL е да предотврати безкрайното циркулиране на пакети в мрежата при наличие на routing loops (зацикляне на маршрутизацията).

**Как работи TTL:**
- Когато пакет се създава, TTL се задава на начална стойност (обикновено 64, 128 или 255)
- Всеки рутер, през който премине пакетът, **намалява TTL с 1**
- Когато TTL достигне **0**, рутерът **изхвърля пакета** и изпраща обратно **ICMP Time Exceeded** съобщение
- По този начин се избягват безкрайни цикли и претоварване на мрежата

**В IPv6:** Вместо TTL се използва **Hop Limit** с идентична функционалност.

#### Time Exceeded (Изтекло време)

**ICMP Time Exceeded** съобщение се изпраща, когато:
- В **IPv4**: TTL (Time to Live) полето достигне 0
- В **IPv6**: Hop Limit полето достигне 0

**Процес:**
1. Пакет пристига на рутер с TTL = 1
2. Рутерът намалява TTL с 1 → TTL става 0
3. Рутерът **изхвърля пакета**
4. Рутерът изпраща **ICMP Time Exceeded** съобщение обратно към източника
5. Съобщението включва IP адреса на рутера

**Използва се от:** командата `tracert` (Windows) / `traceroute` (Linux)

**Как tracert използва ICMP Time Exceeded:**
Командата `tracert` използва умно свойството на TTL за картографиране на маршрута:

1. Изпраща пакет с **TTL=1** → първият рутер го изхвърля и връща Time Exceeded
2. Изпраща пакет с **TTL=2** → вторият рутер го изхвърля и връща Time Exceeded  
3. Изпраща пакет с **TTL=3** → третият рутер го изхвърля и връща Time Exceeded
4. ...продължава докато достигне дестинацията

По този начин tracert "открива" всеки рутер по маршрута, измервайки времето за достигане на всеки hop.

---

## 2. Инструменти за Troubleshooting

### Преглед на командите

| Команда | Функция | Използва ICMP |
|---------|---------|---------------|
| `ipconfig` / `ifconfig` | Показва IP конфигурация | Не |
| `ping` | Тества връзка до други IP хостове | Да (Echo Request/Reply) |
| `netstat` | Показва мрежови връзки | Не |
| `tracert` / `traceroute` | Показва маршрута до дестинацията | Да (Time Exceeded) |
| `nslookup` | Прави заявка към DNS сървър | Не |
| `arp` | Показва/модифицира ARP таблицата | Не |
| `route` | Показва/модифицира routing таблицата | Не |
| `pathping` | Комбинация от ping и tracert | Да |

### ipconfig / ifconfig
Използва се за преглед на IP конфигурацията на устройства.
- **Windows:** `ipconfig`
- **Linux/macOS:** `ifconfig` или `ip addr`

**Полезни опции:**
- `ipconfig /all` - показва подробна информация
- `ipconfig /release` - освобождава IP адреса (DHCP)
- `ipconfig /renew` - обновява IP адреса (DHCP)
- `ipconfig /flushdns` - изчиства DNS кеша

### ping
Най-често използваният мрежов инструмент за тестване на достъпност.

**Как работи:**
1. Изпраща **Echo Request** към IP адрес
2. Дестинацията отговаря с **Echo Reply**
3. При успех - свързаността е потвърдена
4. При грешка - появява се "request timed out" или "general failure"

**Диагностика с ping:**
- Ако ping до IP работи, но до име (www.cisco.com) - не → проблем с DNS
- Ако ping до default gateway работи → проблемът не е локален
- Ако ping до default gateway не работи → проблемът е в локалната мрежа

**Важна бележка:** Ping може да е блокиран от firewall, дори когато мрежата работи!

**Допълнителни опции на ping:**
- `-t` - непрекъснато ping (докато не го спрете с Ctrl+C)
- `-n count` - брой пакети за изпращане
- `-l size` - размер на пакета в байтове
- `-i TTL` - задаване на TTL стойност

### netstat
Показва активни мрежови връзки и статистики.

**Основни опции:**
- `netstat` - показва всички активни TCP връзки
- `netstat -a` - показва всички връзки и слушащи портове
- `netstat -n` - показва адреси и портове в числов формат
- `netstat -r` - показва routing таблицата

**Приложение:** Използва се за откриване на отворени портове, активни връзки и проблеми с мрежовата конфигурация.

### tracert / traceroute
Показва маршрута (пътя) на пакетите до дестинацията и времето за всеки hop.
- **Windows:** `tracert`
- **Linux/macOS:** `traceroute`

**Как работи:**
1. Изпраща пакети с TTL=1, после TTL=2, TTL=3...
2. Всеки рутер по пътя изпраща ICMP Time Exceeded съобщение
3. Така се открива всеки hop до дестинацията

**Приложение:** Полезен за откриване на къде точно пакетите се забавят или губят по маршрута.

### nslookup
Прави заявки директно към DNS сървър за информация за домейни.

**Основна употреба:**
```
nslookup www.cisco.com
```

**Приложение:** Използва се за диагностика на DNS проблеми - проверка дали домейнът се резолва правилно до IP адрес.

### arp
Показва и модифицира ARP (Address Resolution Protocol) таблицата - съответствието между IP и MAC адреси.

**Основни опции:**
- `arp -a` - показва всички записи в ARP таблицата
- `arp -d <IP>` - изтрива запис от ARP таблицата
- `arp -s <IP> <MAC>` - добавя статичен запис

**Приложение:** Използва се за диагностика на проблеми с локалната мрежа (Layer 2), проверка на MAC адреси и откриване на ARP конфликти.

### route
Показва и модифицира routing таблицата на устройството.

**Основни опции:**
- `route print` (Windows) / `route -n` (Linux) - показва routing таблицата
- `route add` - добавя маршрут
- `route delete` - изтрива маршрут

**Приложение:** Използва се за проверка на маршрутизацията и добавяне на статични маршрути.

### pathping (само Windows)
Комбинира функционалността на ping и tracert - показва маршрута и статистика за загуба на пакети на всеки hop.

**Как работи:**
1. Първо извършва tracert за откриване на маршрута
2. След това изпраща множество пакети към всеки hop за статистика
3. Показва детайлна информация за загуба на пакети и латентност

**Приложение:** По-мощен от tracert за диагностика - помага да се открие точно кой hop причинява проблеми с производителността.

---

## Методика за диагностика

```
1. Проверка на локална IP конфигурация
   → ipconfig /all (Windows) или ip addr (Linux)
   → Проверка: IP адрес, subnet mask, default gateway, DNS
   
2. Проверка на локална свързаност
   → ping 127.0.0.1 (loopback - проверка на TCP/IP stack)
   
3. Проверка на локалната мрежа (Layer 2)
   → arp -a (проверка на ARP таблица)
   → ping към друг хост в локалната мрежа
   
4. Проверка на default gateway
   → ping <gateway IP>
   
5. Проверка на външна свързаност
   → ping <външен IP адрес> (напр. 8.8.8.8)
   
6. Проверка на DNS
   → ping <домейн име> (напр. www.google.com)
   → nslookup <домейн име>
   
7. Анализ на маршрута и производителност
   → tracert <дестинация> (бърз преглед)
   → pathping <дестинация> (детайлна статистика)
   
8. Проверка на активни връзки и портове
   → netstat -a
   → netstat -n (числов формат)
   
9. Проверка на routing таблица
   → route print (Windows) / route -n (Linux)
```

**Интерпретация на резултатите:**
- ✅ Всичко работи → Проблемът е в приложението или услугата
- ❌ DNS не работи (ping IP работи, но име - не) → DNS проблем (проверка с nslookup)
- ❌ Gateway не работи → Локален мрежов проблем (проверка на кабел, switch, ARP)
- ❌ Външна връзка не работи (gateway работи) → Проблем с ISP или routing (tracert за детайли)
- ❌ Loopback не работи → Проблем с TCP/IP stack (преинсталация на мрежови драйвери)

---

## Ключови моменти

✅ ICMP е протокол за съобщения за грешки и информационни съобщения в IP мрежите  
✅ ICMP не прави IP надежден, но осигурява обратна връзка за проблеми  
✅ **ping** използва ICMP Echo Request/Reply за проверка на достъпност  
✅ **tracert** използва ICMP Time Exceeded съобщения (чрез TTL) за картографиране на маршрута  
✅ **pathping** комбинира ping и tracert за по-детайлна диагностика  
✅ **ipconfig** е първата стъпка - винаги проверявайте локалната конфигурация  
✅ **netstat** показва активни връзки и отворени портове  
✅ **nslookup** диагностицира DNS проблеми  
✅ **arp** показва съответствието между IP и MAC адреси (Layer 2)  
✅ **route** показва routing таблицата и позволява модификация на маршрути  
✅ Винаги започвайте диагностиката от локалната мрежа навън  
❌ Помнете, че ICMP може да е блокиран от firewall - липсата на отговор не винаги означава проблем!  

---

**гл. ас. Светослав Атанасов**  
svetoslav.atanasov@trakia-uni.bg


<script data-goatcounter="https://satanasov.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<script src="/SNA/assets/js/analytics-logger.js"></script>
