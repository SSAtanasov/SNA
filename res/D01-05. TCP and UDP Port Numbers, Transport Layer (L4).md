# D01-05: TCP и UDP портове

## Цел на лекцията
Разбиране как номерата на портовете идентифицират услуги и позволяват множество едновременни комуникации на транспортния слой

---

## 1. Въведение в портовете

### Защо са нужни портовете?

Когато използваме интернет през деня, имаме нужда от множество услуги едновременно: DNS, web, email, FTP, instant messaging, VoIP. Всички тези услуги могат да работат едновременно на едно устройство благодарение на **портовете**.

**Портът** е числов идентификатор в сегмента (TCP или UDP), който се използва за проследяване на специфични разговори между клиент и сървър.

**Ключова функция:** Портовете позволяват на транспортния слой да разграничава множество едновременни комуникации и да ги насочва към правилното приложение.

### TCP и UDP използват портове

И двата транспортни протокола - **TCP** и **UDP** - използват портове:

**TCP (Transmission Control Protocol):**
- Connection-oriented, надежден протокол
- Използва портове за идентификация на приложения
- Примери: HTTP (80), HTTPS (443), FTP (21), SSH (22)

**UDP (User Datagram Protocol):**
- Connectionless, бърз протокол
- Използва портове за идентификация на приложения
- Примери: DNS (53), DHCP (67/68), TFTP (69)

**Забележка:** Ще разглеждаме TCP и UDP подробно в отделни лекции. Тук фокусът е на портовете.

---

## 2. Структура на портовете

### Полета в TCP/UDP заглавки

Всяка TCP или UDP заглавка съдържа:
- **Source Port** (16 bits) - портът на изпращача
- **Destination Port** (16 bits) - портът на получателя

**16-битово поле = диапазон 0-65535**

### Source vs Destination Port

**Destination Port:**
- Идентифицира **услугата** на сървъра
- Използва well-known port номера
- Примери: HTTP=80, HTTPS=443, SSH=22

**Source Port:**
- Assign-ва се **динамично** от клиента
- Действа като **адрес за връщане**
- Уникално идентифицира комуникацията на клиента

---

## 3. Как работят портовете

### Пример: Web Browser заявка

**Стъпки на комуникация:**

1. **Клиентът (Browser) отваря страница:**
   - Операционната система **динамично assign-ва** source port (напр. 5305)
   - Заявката се изпраща с:
     - Source Port: **5305**
     - Destination Port: **80** (HTTP)

2. **Пакетът се движи към сървъра:**
   - Сървърът получава пакета на порт 80
   - Разбира че е HTTP заявка
   - Обработва заявката

3. **Сървърът отговаря:**
   - Source Port: **80**
   - Destination Port: **5305**

4. **Клиентът получава отговора:**
   - Вижда destination port 5305
   - Знае че това е за web browser
   - Препраща данните към browser приложението

### Визуализация на потока

```
ЗАЯВКА (Client → Server):
┌──────────────────────────────────────┐
│ Source: 192.168.1.5:5305            │
│ Destination: 192.168.1.7:80         │
│ [HTTP GET Request]                   │
└──────────────────────────────────────┘

ОТГОВОР (Server → Client):
┌──────────────────────────────────────┐
│ Source: 192.168.1.7:80              │
│ Destination: 192.168.1.5:5305       │
│ [HTTP Response - Web Page]           │
└──────────────────────────────────────┘
```

---

## 4. Множество едновременни комуникации

### Multiple Separate Communications

Благодарение на портовете, едно устройство може да има **множество активни комуникации едновременно** с един или няколко сървъра.

### Пример: Едновременни услуги

Компютър с IP **192.168.1.5** комуникира със сървър **192.168.1.7**:

**Комуникация 1 - Web Browser:**
- Source: 192.168.1.5:**5305**
- Destination: 192.168.1.7:**80**
- Услуга: HTTP

**Комуникация 2 - FTP Client:**
- Source: 192.168.1.5:**1099**
- Destination: 192.168.1.7:**21**
- Услуга: FTP

**Комуникация 3 - Email Client:**
- Source: 192.168.1.5:**5310**
- Destination: 192.168.1.7:**25**
- Услуга: SMTP

**Всички три работят едновременно!** Транспортният слой разграничава комуникациите чрез различните source ports.

### Как Transport Layer управлява множеството връзки

1. **Проследява всеки port** и съответното приложение
2. **При получаване на данни:**
   - Проверява destination port
   - Препраща данните към правилното приложение
3. **При изпращане на данни:**
   - Добавя правилния source port
   - Гарантира уникалност на комуникацията

---

## 5. Socket Pairs (Двойки сокети)

### Какво е Socket?

**Socket** е комбинация от **IP адрес : Port**

**Примери:**
- `192.168.1.5:1099` - клиентски socket
- `192.168.1.7:80` - сървърен socket

### Socket Pair

**Socket pair** е комбинацията от source socket и destination socket:

**Формат:**
```
Source_IP:Source_Port, Destination_IP:Destination_Port
```

**Пример за FTP комуникация:**
```
192.168.1.5:1305, 192.168.1.7:21
```

**Пример за Web комуникация:**
```
192.168.1.5:1099, 192.168.1.7:80
```

### Защо са важни Socket Pairs?

✅ **Уникална идентификация** на всяка комуникация  
✅ Позволяват **множество процеси** на клиент да се разграничават  
✅ Позволяват **множество връзки** към един сървър  
✅ Source port действа като **return address** за приложението  
✅ Transport layer използва socket pairs за **routing на отговорите**

### Пример с Layer модела

**FTP заявка:**
- **Layer 2:** MAC адреси (физическа доставка)
- **Layer 3:** IP адреси 192.168.1.5 → 192.168.1.7
- **Layer 4:** Портове 1305 → 21
- **Socket Pair:** 192.168.1.5:1305, 192.168.1.7:21

**Web заявка (едновременно към същия сървър):**
- **Layer 2:** Същите MAC адреси
- **Layer 3:** Същите IP адреси 192.168.1.5 → 192.168.1.7
- **Layer 4:** Портове 1099 → 80
- **Socket Pair:** 192.168.1.5:1099, 192.168.1.7:80

Двете комуникации се разграничават на Layer 4 чрез различните портове!

---

## 6. Групи портове (Port Number Groups)

**IANA (Internet Assigned Numbers Authority)** управлява стандартите за портове.

### Три категории портове

| Група | Диапазон | Предназначение | Assign-ване |
|-------|----------|----------------|-------------|
| Well-Known Ports | 0-1023 | Стандартни услуги | IANA официално |
| Registered Ports | 1024-49151 | Специфични приложения | IANA по заявка |
| Dynamic/Private Ports | 49152-65535 | Клиентски source ports | Динамично от ОС |

### Well-Known Ports (0-1023)

**Характеристики:**
- Запазени за **стандартни услуги**
- Автоматично разпознаваеми от клиентите
- Изискват **администраторски права** за binding (на повечето ОС)
- Стриктно управлявани от IANA

**Най-важни Well-Known Ports:**

| Порт | Протокол | Услуга | TCP/UDP |
|------|----------|--------|---------|
| 20 | FTP-DATA | FTP Data Transfer | TCP |
| 21 | FTP | FTP Control | TCP |
| 22 | SSH | Secure Shell | TCP |
| 23 | Telnet | Telnet | TCP |
| 25 | SMTP | Email (изпращане) | TCP |
| 53 | DNS | Domain Name System | TCP/UDP |
| 67 | DHCP | DHCP Server | UDP |
| 68 | DHCP | DHCP Client | UDP |
| 69 | TFTP | Trivial FTP | UDP |
| 80 | HTTP | Web (незащитен) | TCP |
| 110 | POP3 | Email (получаване) | TCP |
| 143 | IMAP | Email (получаване) | TCP |
| 161 | SNMP | Network Management | UDP |
| 162 | SNMP | SNMP Trap | UDP |
| 443 | HTTPS | Web (защитен/SSL) | TCP |

### Registered Ports (1024-49151)

**Характеристики:**
- Регистрирани за **специфични услуги** и приложения
- Не са строго запазени, но се препоръчват
- Могат да се използват от обикновени потребители

**Популярни Registered Ports:**

| Порт | Услуга |
|------|--------|
| 1433 | Microsoft SQL Server |
| 1521 | Oracle Database |
| 3306 | MySQL Database |
| 3389 | RDP (Remote Desktop) |
| 5432 | PostgreSQL |
| 8080 | HTTP Alternate (web proxy) |
| 8443 | HTTPS Alternate |

### Dynamic/Private Ports (49152-65535)

**Характеристики:**
- Използват се за **source ports** на клиенти
- Assign-ват се **динамично** от операционната система
- **Временни** - освобождават се след приключване на комуникацията
- Не са регистрирани официално

**Как работи dynamic port assignment:**
1. Приложение прави мрежова заявка
2. ОС избира **случаен порт** от dynamic range
3. Използва го като source port
4. След приключване на комуникацията, портът се освобождава

**Забележка:** Някои операционни системи използват registered ports (1024-49151) вместо dynamic range за source ports.

---

## 7. Портове при TCP и UDP

### Портове, използващи и TCP и UDP

Някои услуги използват **и двата протокола** за различни функции:

**DNS (Domain Name System) - Порт 53:**
- **UDP 53:** Клиентски DNS queries (малки, бързи заявки)
- **TCP 53:** DNS Zone Transfers между сървъри (големи данни)

**DHCP (Dynamic Host Configuration Protocol):**
- **UDP 67:** DHCP Server
- **UDP 68:** DHCP Client

### Само TCP портове

Услуги, изискващи **надеждна доставка:**

| Порт | Услуга | Защо TCP? |
|------|--------|-----------|
| 20, 21 | FTP | Надеждно предаване на файлове |
| 22 | SSH | Критична точност на командите |
| 23 | Telnet | Надежден терминален достъп |
| 25 | SMTP | Гарантирана доставка на email |
| 80 | HTTP | Пълно зареждане на web страници |
| 110 | POP3 | Надеждно теглене на email |
| 143 | IMAP | Синхронизация на email |
| 443 | HTTPS | Сигурна web комуникация |

### Само UDP портове

Услуги, изискващи **скорост:**

| Порт | Услуга | Защо UDP? |
|------|--------|-----------|
| 53 | DNS | Бързи queries |
| 67, 68 | DHCP | Прост request/response |
| 69 | TFTP | Прост file transfer |
| 161, 162 | SNMP | Real-time monitoring |

---

## 8. Командата netstat

### Какво е netstat?

**netstat** е инструмент за **проверка на активни портове и връзки**.

### Основна употреба

```bash
netstat
```

**Показва:**
- **Proto** - Протокол (TCP/UDP)
- **Local Address** - Локален IP:порт
- **Foreign Address** - Отдалечен IP:порт
- **State** - Състояние на връзката

### Важни опции

**Windows:**
```bash
netstat -a        # Всички връзки и listening портове
netstat -n        # Числов формат (без DNS resolve)
netstat -b        # Показва процеса (requires admin)
netstat -o        # Показва Process ID (PID)
netstat -ano      # Комбинация: всички, numeric, PID
```

**Linux:**
```bash
netstat -tuln     # TCP, UDP, listening, numeric
netstat -tulnp    # + показва процеса (requires root)
```

### TCP Connection States

| State | Значение |
|-------|----------|
| **LISTENING** | Портът чака за входящи връзки (сървър) |
| **ESTABLISHED** | Активна връзка |
| **TIME_WAIT** | Връзката е приключила, чака timeout |
| **CLOSE_WAIT** | Отдалечената страна е затворила връзката |
| **SYN_SENT** | Опит за установяване на връзка |
| **SYN_RECEIVED** | Получена заявка за връзка |

### Практични примери

**1. Проверка на listening портове:**
```bash
netstat -an | findstr LISTENING
```

**2. Проверка кой процес използва порт 80:**
```bash
netstat -ano | findstr :80
```

**3. Проверка на всички ESTABLISHED връзки:**
```bash
netstat -an | findstr ESTABLISHED
```

**4. Проверка на UDP връзки:**
```bash
netstat -an -p UDP
```

### Security приложение

**Откриване на неочаквани връзки:**
- Неочаквани TCP връзки могат да индикират malware
- Отворени портове без ваше знание = security риск
- Редовна проверка с netstat за необичайна активност

**Пример за анализ:**
```bash
netstat -ano
```
Ако видите странни foreign addresses или неочаквани listening портове → investigate!

---

## 9. Практически съвети

### Избор на портове за собствени приложения

**Препоръки:**
- **Използвайте Registered Ports (1024-49151)** за вашите услуги
- **Избягвайте Well-Known Ports** - те са запазени
- **Проверявайте IANA registry** за конфликти
- **Документирайте** използваните портове

### Troubleshooting с портове

**Типични проблеми:**

1. **"Port already in use"**
   - Друго приложение вече слуша на този порт
   - Проверка: `netstat -ano | findstr :PORT`

2. **"Connection refused"**
   - Порт не е отворен на дестинацията
   - Проверка: firewall, услугата не работи

3. **"Connection timeout"**
   - Firewall блокира порта
   - Мрежови проблем по маршрута

### Security Best Practices

✅ Затваряйте ненужни портове  
✅ Използвайте firewall за контрол на достъпа до портове  
✅ Редовно проверявайте с `netstat` за неочаквани отворени портове  
✅ Не оставяйте default портове отворени без защита  
✅ Използвайте нестандартни портове за критични услуги (не е достатъчна мярка сама по себе си)  
❌ Не разчитайте само на "security through obscurity"  

---

## 10. Ключови моменти

✅ **Портовете** са 16-битови идентификатори (0-65535) в TCP/UDP заглавките  
✅ **Destination port** идентифицира услугата на сървъра  
✅ **Source port** се assign-ва динамично и служи като return address  
✅ **Well-Known Ports (0-1023)** са запазени за стандартни услуги  
✅ **Dynamic Ports (49152-65535)** се използват за клиентски source ports  
✅ **Socket** = IP:Port (напр. 192.168.1.5:1099)  
✅ **Socket Pair** уникално идентифицира една комуникация  
✅ Портовете позволяват **множество едновременни комуникации** на едно устройство  
✅ **netstat** е ключов инструмент за мониторинг на портове и връзки  
✅ Някои услуги използват **и TCP и UDP** портове (напр. DNS на порт 53)  
❌ Неочаквани отворени портове са **security риск**  

---

**гл. ас. Светослав Атанасов**  
svetoslav.atanasov@trakia-uni.bg


<script data-goatcounter="https://satanasov.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<script src="/SNA/assets/js/analytics-logger.js"></script>
