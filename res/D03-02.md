# Routing Between Networks (Маршрутизация между мрежи)
## Записки за подготовка на студентите

---

## Мрежови граници (Network Boundaries)

### Маршрутизаторите като шлюзове (Routers as Gateways)

**Основна функция на маршрутизатора:**
Маршрутизаторът предоставя шлюз (gateway), чрез който устройствата в една мрежа могат да комуникират с устройства в различни мрежи.

**Как работи:**
- Всеки интерфейс на маршрутизатора е свързан към **отделна мрежа**
- IPv4 адресът, присвоен на интерфейса, идентифицира коя локална мрежа е свързана директно към него

**Default Gateway (Шлюз по подразбиране):**
Всяко устройство в мрежата трябва да използва маршрутизатора като шлюз към други мрежи. Следователно, всяко устройство трябва да знае IPv4 адреса на интерфейса на маршрутизатора, свързан към мрежата, където се намира устройството. Този адрес се нарича **адрес на шлюз по подразбиране** (default gateway address).

**Конфигуриране на Default Gateway:**
Може да бъде:
- **Статично конфигуриран** на устройството
- **Получен динамично** чрез DHCP

**Практически пример:**
Когато безжичен маршрутизатор е конфигуриран като DHCP сървър за локалната мрежа, той автоматично изпраща правилния IPv4 адрес на интерфейса към устройствата като адрес на шлюз по подразбиране. По този начин всички устройства в мрежата могат да използват този IPv4 адрес за препращане на съобщения до устройства, намиращи се при ISP, и за достъп до устройства в интернет.

**Забележка:** Безжичните маршрутизатори обикновено са конфигурирани да бъдат DHCP сървъри по подразбиране.

---

### Маршрутизаторите като граници между мрежи

**Вътрешна (Internal) мрежа:**
Безжичният маршрутизатор действа като DHCP сървър за всички локални устройства, свързани към него - или чрез Ethernet кабел, или безжично. Тези локални устройства се наричат разположени във **вътрешна** или **вътре** (inside) мрежа.

**Частни адреси:**
Повечето DHCP сървъри са конфигурирани да присвояват **частни адреси** на устройствата във вътрешната мрежа, вместо публични адреси, маршрутизируеми в интернет. Това гарантира, че по подразбиране вътрешната мрежа **не е директно достъпна от интернет**.

**Типична конфигурация:**
- **Първият адрес** в мрежата обикновено се присвоява на локалния интерфейс на безжичния маршрутизатор
- Вътрешните устройства трябва да получат адреси в **същата мрежа** като безжичния маршрутизатор
- Конфигурацията може да бъде статична или чрез DHCP

**Информация, предоставяна от DHCP:**
Когато е конфигуриран като DHCP сървър, безжичният маршрутизатор предоставя:
1. IP адрес в правилния диапазон
2. Информация за мрежовата маска (subnet mask)
3. Собствения си интерфейсен IPv4 адрес като шлюз по подразбиране

**Външна (External) връзка:**
Много ISP също използват DHCP сървъри за предоставяне на IPv4 адреси на интерфейса на маршрутизатора, който се свързва към техните мрежи.

---

## Необходимостта от маршрутизация

### Защо разделяме мрежите?

**Контекст:**
Когато мрежите нарастват, става необходимо да се разделят от една голяма локална мрежа на множество по-малки локални мрежови сегменти.

**Практически пример:**
Представете си организация с три основни отдела:
- Мрежово управление (Network Management)
- Счетоводство (Accounting)
- Продажби (Sales)

**Основни причини за разделяне:**

**1. Ограничаване на broadcast трафика**
- Всеки broadcast, генериран от устройство в една мрежа, трябва да бъде приет и обработен от **всички** устройства в broadcast домейна
- Дори устройство в отдел "Мрежово управление" ще трябва да приеме и обработи broadcast от отдел "Продажби"
- Разделянето намалява ненужния broadcast трафик

**2. Изисквания за сигурност**
- Маршрутизаторите в distribution layer могат да отделят и защитят определени групи компютри, където се съхранява поверителна информация
- Контрол на достъпа между отдели

**3. Физически местоположения**
- Маршрутизаторите могат да свързват локални мрежи на различни географски разделени местоположения на организацията

**4. Логическо групиране**
- Маршрутизаторите могат да групират логически потребители (например отдели в компания), които имат общи нужди или достъп до ресурси

**Distribution Layer (Разпределителен слой):**
Distribution layer свързва тези независими локални мрежи и контролира трафика, който тече между тях. Той е отговорен за гарантиране, че трафикът между устройствата в локалната мрежа остава локален.

---

### Локални срещу отдалечени устройства

**Локални устройства (Local hosts):**
Устройства в същата мрежа като изходящото устройство

**Отдалечени устройства (Remote hosts):**
Устройства извън локалния мрежов сегмент

**Ключово правило:**
Когато изходно устройство изпраща пакет до отдалечено устройство, е необходима помощта на маршрутизатори и маршрутизация.

---

### Какво е маршрутизация (Routing)?

**Определение:**
Маршрутизацията е процесът на идентифициране на **най-добрия път** до дестинация.

**Маршрутизатор (Router):**
Мрежово устройство, което свързва множество Layer 3 (IP) мрежи. На distribution layer на мрежата маршрутизаторите насочват трафика и изпълняват други функции, критични за ефективната работа на мрежата.

**Разлика между Switch и Router:**

| **Switch** | **Router** |
|------------|------------|
| Взима решение за препращане въз основа на Layer 2 MAC адрес | Взима решение за препращане въз основа на Layer 3 IP адрес |
| Работи на Data Link Layer | Работи на Network Layer |
| Свързва устройства в една мрежа | Свързва различни мрежи |

**Общо:** И двете могат да декодират и четат съобщенията, които им се изпращат

---

### Формат на пакета

**IP Packet съдържа:**
- IP адрес на **дестинацията**
- IP адрес на **източника**
- Данни на съобщението, изпращани между тях

**Инкапсулация:**
IP пакетът се инкапсулира в Ethernet рамка (frame) за предаване по физическата мрежа.

---

## Таблицата за маршрутизация (Routing Table)

### Как маршрутизаторът препраща пакети

**Процес на препращане (стъпка по стъпка):**

**Практически пример:**
Устройство H1 с адрес `10.0.0.1` иска да изпрати пакет до устройство H4 с адрес `192.168.1.2` (друга мрежа)

**Стъпка 1: Създаване на пакета**
```
Изходящ IP адрес:  10.0.0.1
Целеви IP адрес:   192.168.1.2
```

**Стъпка 2: H1 изпраща до default gateway**
- H1 знае, че адресът `192.168.1.2` е в **различна мрежа**
- H1 изпраща пакета до своя default gateway (маршрутизатора)
- В Ethernet рамката се използва **MAC адресът на маршрутизатора**

**Стъпка 3: Маршрутизаторът получава пакета**
- Декапсулира рамката, за да стигне до IP пакета
- Прочита **целевия IPv4 адрес** в пакета: `192.168.1.2`

**Стъпка 4: Търсене в routing table**
- Маршрутизаторът търси целевия адрес `192.168.1.2` в таблицата за маршрутизация
- Открива, че `192.168.1.2` принадлежи към мрежа `192.168.1.0`
- Мрежа `192.168.1.0` е свързана към интерфейс **FastEthernet 0/2**

**Стъпка 5: Препращане на пакета**
- Маршрутизаторът препраща пакета през интерфейс FastEthernet 0/2
- Инкапсулира пакета в нова Ethernet рамка
- Използва MAC адреса на H4 като целеви MAC адрес (получен чрез ARP)

**Стъпка 6: Получаване от H4**
- H4 получава рамката
- Декапсулира рамката и обработва IP пакета

---

### Съдържание на routing table

**Какво съдържа routing table:**
Маршрутизаторите преместват информация между локални и отдалечени мрежи. За да направят това, те трябва да използват таблици за маршрутизация за съхранение на информация.

**Важно:** Таблиците за маршрутизация **НЕ** се интересуват от адресите на отделни устройства. Таблиците за маршрутизация съдържат:
- **Адреси на мрежи** (не на отделни устройства)
- **Най-добрия път** за достигане на тези мрежи

---

### Записи в routing table

**Два начина за попълване на routing table:**

**1. Динамично обновяване (Dynamic routing)**
- Автоматично обновяване чрез информация, получена от други маршрутизатори в мрежата
- Използват се протоколи за динамична маршрутизация (например OSPF, EIGRP, RIP)

**2. Ръчно въвеждане (Static routing)**
- Ръчно въвеждане от мрежов администратор
- Статични маршрути

**Използване на таблицата:**
Маршрутизаторите използват таблиците за маршрутизация, за да определят кой **интерфейс** да използват за препращане на съобщение до планираната дестинация.

**Какво става при неизвестна дестинация:**
Ако маршрутизаторът не може да определи къде да препрати съобщение, той ще го **отхвърли** (drop).

---

### Default Route (Маршрут по подразбиране)

**Проблем:**
Ако дестинационната мрежа не е в таблицата за маршрутизация, пакетът ще бъде отхвърлен.

**Решение:**
Мрежовите администратори конфигурират **статичен default route**, който се поставя в таблицата за маршрутизация.

**Определение:**
Default route е интерфейсът, през който маршрутизаторът препраща пакет, съдържащ неизвестен целеви IP мрежов адрес.

**Приложение:**
Обикновено този default route свързва към друг маршрутизатор, който може да обслужва пакета. Често това е път към маршрутизатор при ISP.

**Визуално:** Default route може да се мисли като "изпрати всичко неизвестно натам" →

---

### Препращане на пакета

**Два възможни сценария:**

**Сценарий 1: Директно свързана мрежа**
Маршрутизаторът препраща пакета към директно свързана мрежа, съдържаща действителното устройство-дестинация.

**Сценарий 2: Друг маршрутизатор**
Маршрутизаторът препраща пакета към друг маршрутизатор по пътя към целевото устройство.

**MAC адрес при препращане:**
Когато маршрутизатор инкапсулира рамката за препращане през маршрутизиран интерфейс, той трябва да включи **целеви MAC адрес**.

- Ако маршрутизаторът трябва да препрати пакета към друг маршрутизатор през маршрутизиран интерфейс, той ще използва **MAC адреса на свързания маршрутизатор**
- Маршрутизаторите получават тези MAC адреси от **ARP таблици**

---

## Default Gateway (Шлюз по подразбиране)

### Как устройството изпраща съобщения

**Метод за изпращане зависи от дестинацията:**

**Случай 1: Дестинация в същата локална мрежа**
- Устройството препраща съобщението **директно**
- Използва ARP за откриване на MAC адреса на устройството-дестинация
- IPv4 пакетът съдържа целевия IPv4 адрес
- Инкапсулира пакета в рамка с MAC адреса на дестинацията
- Препраща директно

**Случай 2: Дестинация в отдалечена мрежа**
- Устройството трябва да използва **маршрутизатора**
- IPv4 пакетът съдържа IP адреса на целевото устройство (както преди)
- Когато инкапсулира пакета в рамка, използва **MAC адреса на маршрутизатора** като целеви MAC
- По този начин маршрутизаторът ще получи и приеме рамката въз основа на MAC адреса

**Как устройството определя MAC адреса на маршрутизатора?**
Устройството получава IPv4 адреса на маршрутизатора чрез **default gateway адреса**, конфигуриран в неговите TCP/IP настройки.

**Default gateway адресът:**
- Адресът на интерфейса на маршрутизатора, свързан към **същата локална мрежа** като изходящото устройство
- Всички устройства в локалната мрежа използват default gateway адреса за изпращане на съобщения до маршрутизатора

**Процес на определяне на MAC адрес:**
1. Устройството има IP адреса на default gateway (от конфигурация или DHCP)
2. Устройството използва ARP за намиране на MAC адреса, съответстващ на този IP адрес
3. Устройството запазва MAC адреса в своята ARP таблица за бъдеща употреба

---

## Създаване на локална мрежа (LAN)

### Какво е LAN?

**Определение:**
Терминът Local Area Network (LAN) се отнася до локална мрежа или група от взаимосвързани локални мрежи, които са под **едно административно управление**.

**Еволюция на определението:**
- В ранните дни на мрежите: LAN бяха малки мрежи в едно физическо местоположение
- Съвременно определение: LAN може да включва стотици устройства, инсталирани в множество сгради и местоположения

**Важното:** Всички локални мрежи в рамките на един LAN са под **едно административно управление**.

**Общи характеристики на LAN:**
- Обикновено използват **Ethernet** или **безжични** протоколи
- Поддържат **високи скорости** на пренос на данни

**Intranet:**
Терминът "intranet" често се използва за частен LAN, който принадлежи на организация и е проектиран да бъде достъпен само от членове на организацията, служители или други с разрешение.

---

### Локални и отдалечени мрежови сегменти

В рамките на LAN е възможно да се постави всички устройства в една локална мрежа или да се разделят между множество мрежи, свързани чрез distribution layer устройство.

**Как се определя разпределението:**
Зависи от желаните резултати и нуждите на организацията.

---

### Вариант 1: Всички устройства в един локален сегмент

**Описание:**
Поставяне на всички устройства в една локална мрежа позволява те да бъдат "видими" от всички други устройства.

**Защо е така:**
- Има **един broadcast домейн**
- Устройствата използват **ARP**, за да се намират взаимно

**Подходящо за:**
По-прости мрежи, където е желателна директна комуникация между всички устройства

---

### Предимства на един локален сегмент

**1. Подходящо за по-прости мрежи**
- По-лесна конфигурация
- По-малко мрежово оборудване

**2. По-малка сложност и по-ниска мрежова цена**
- Не са необходими маршрутизатори
- По-малко устройства за управление

**3. Позволява на устройствата да бъдат "видими" от други устройства**
- Лесна комуникация между всички устройства
- Споделяне на ресурси без допълнителна конфигурация

**4. По-бърз трансфер на данни**
- По-директна комуникация
- Без латентност от маршрутизация

**5. Лекота на достъп до устройства**
- Директен достъп между всички устройства
- Не е необходима конфигурация на маршрутизация

---

### Недостатъци на един локален сегмент

**1. Всички устройства са в един broadcast домейн**
- Генерира **повече трафик** в мрежата
- Всички устройства трябва да обработват всички broadcasts

**2. Намалена производителност**
- При нарастване на броя устройства, производителността пада
- Повече колизии и забавяне

**3. По-ниска сигурност**
- Всички устройства могат да виждат трафика на други устройства (в хъб среда)
- По-трудно изолиране на чувствителни данни

**4. Труден мащаб**
- Трудно се управлява при голям брой устройства
- Производителността се влошава значително

**5. Организационни проблеми**
- Трудно логическо групиране на устройства
- Всички устройства в един "котел"

---

### Вариант 2: Устройства в отдалечени сегменти

**Описание:**
Поставяне на допълнителни устройства в отдалечена мрежа ще намали въздействието на изискванията за трафик.

**Важно ограничение:**
Устройствата в една мрежа **няма да могат** да комуникират с устройства в друга мрежа без използването на **маршрутизация**.

**Компромис:**
- Маршрутизаторите увеличават сложността на мрежовата конфигурация
- Маршрутизаторите могат да въведат **латентност** (забавяне) на пакети, изпратени от една локална мрежа до друга

---

### Предимства на отдалечени сегменти

**1. По-подходящо за по-големи, по-сложни мрежи**
- Мащабируемост
- По-добро управление

**2. Разделя broadcast домейните и намалява трафика**
- Всеки сегмент е отделен broadcast домейн
- Broadcast трафикът остава локален

**3. Може да подобри производителността на всеки сегмент**
- По-малко устройства в broadcast домейн
- По-малко колизии

**4. Прави устройствата "невидими" за тези в други локални мрежови сегменти**
- Допълнителна сигурност
- Изолация на трафика

**5. Може да осигури повишена сигурност**
- Контрол на достъпа между сегменти
- Изолиране на чувствителни данни

**6. Подобрява мрежовата организация**
- Логическо групиране (по отдел, по функция, по местоположение)
- По-лесно управление

---

### Недостатъци на отдалечени сегменти

**1. Изисква използването на маршрутизация (distribution layer)**
- Необходимост от маршрутизатори
- Допълнителна конфигурация

**2. Маршрутизаторът може да забави трафика между сегментите**
- Латентност при маршрутизация
- Време за обработка на пакети

**3. Повече сложност и разходи**
- Необходими са маршрутизатори
- Необходимо е познаване на маршрутизация
- По-висока цена на оборудването

---

## Решение: Един сегмент или множество сегменти?

**Решението зависи от:**

**Размер на мрежата:**
- Малка мрежа (< 50 устройства) → Вероятно един сегмент
- Средна/голяма мрежа (> 50 устройства) → Множество сегменти

**Изисквания за сигурност:**
- Висока сигурност → Множество сегменти с контрол на достъпа
- Ниска сигурност → Един сегмент е достатъчен

**Производителност:**
- Нужда от висока производителност → Множество по-малки сегменти
- Базови нужди → Един сегмент може да свърши работа

**Организационна структура:**
- Множество отдели/локации → Множество сегменти
- Малка организация, едно местоположение → Един сегмент

**Бюджет:**
- Ограничен бюджет → Един сегмент (по-евтино)
- Наличен бюджет → Множество сегменти (по-добро дългосрочно решение)

---

## Обобщение

### Ключови моменти

**1. Необходимостта от маршрутизация:**
Когато мрежите нарастват, често е необходимо да се раздели един access layer на множество access layer мрежи. Маршрутизаторите в distribution layer свързват тези независими локални мрежи и контролират трафика между тях.

**2. Маршрутизаторът като Layer 3 устройство:**
Маршрутизаторът е мрежово устройство, което свързва множество Layer 3 (IP) мрежи. За разлика от switch-овете, които вземат решения въз основа на Layer 2 MAC адрес, маршрутизаторите вземат решения въз основа на Layer 3 IP адрес.

**3. Правило за използване на маршрутизатор:**
Когато мрежовата част на IP адресите на източника и дестинацията **не съвпадат**, трябва да се използва маршрутизатор за препращане на съобщението.

**4. Таблицата за маршрутизация:**
Всеки порт (интерфейс) на маршрутизатора се свързва към различна локална мрежа. Всеки маршрутизатор съдържа таблица на всички локално свързани мрежи и интерфейсите, които се свързват към тях.

**5. Процесът на маршрутизация:**
Процесът на препращане на пакети към тяхната дестинационна мрежа се нарича **routing** (маршрутизация).

**6. Default Gateway:**
Default gateway адресът е адресът на интерфейса на маршрутизатора, свързан към същата локална мрежа като изходящото устройство. Всички устройства в локалната мрежа използват default gateway адреса за изпращане на съобщения до маршрутизатора.

**7. LAN определение:**
LAN се отнася до локална мрежа или група взаимосвързани локални мрежи, които са под едно административно управление.

---

## Въпроси за самопроверка

1. Каква е основната функция на маршрутизатора?
2. Какво е default gateway?
3. Как устройство получава адреса на default gateway?
4. Каква е разликата между switch и router?
5. Какво съдържа таблицата за маршрутизация?
6. По какви два начина може да се попълни routing table?
7. Какво е default route и защо е необходим?
8. Кога устройство изпраща пакет директно, а кога през маршрутизатор?
9. Какви са предимствата на разделянето на една голяма мрежа на множество по-малки?
10. Какви са недостатъците на използването на маршрутизатори?
11. Как маршрутизаторът определя MAC адреса на следващия hop?
12. Какво прави маршрутизатор с пакет, чиято дестинация не е в routing table и няма default route?

---

## Основни термини за запомняне

- **Router (Маршрутизатор)** - Layer 3 устройство, свързващо различни IP мрежи
- **Gateway (Шлюз)** - устройство, осигуряващо достъп до друга мрежа
- **Default Gateway** - IP адресът на маршрутизатора, използван от устройства за достъп до други мрежи
- **Routing (Маршрутизация)** - процес на определяне на най-добрия път до дестинация
- **Routing Table** - таблица в маршрутизатора със информация за мрежи и пътища до тях
- **Local Host** - устройство в същата мрежа
- **Remote Host** - устройство в различна мрежа
- **Default Route** - път по подразбиране за неизвестни дестинации
- **Distribution Layer** - слой на мрежата, където се извършва маршрутизация между мрежи
- **Static Route** - ръчно конфигуриран маршрут
- **Dynamic Route** - автоматично научен маршрут от протоколи за маршрутизация
- **LAN (Local Area Network)** - локална мрежа под едно административно управление
- **Intranet** - частна LAN на организация
- **Broadcast Domain** - област, в която се разпространяват broadcast съобщения
- **Latency (Латентност)** - забавяне в мрежата

---

## Практически сценарии

### Сценарий 1: Определяне дали е необходим router

**Дадено:**
- Устройство A: `192.168.1.10/24`
- Устройство B: `192.168.1.50/24`

**Въпрос:** Могат ли да комуникират директно?

**Отговор:** ДА - и двете са в мрежа `192.168.1.0/24`

---

**Дадено:**
- Устройство A: `192.168.1.10/24`
- Устройство C: `192.168.2.10/24`

**Въпрос:** Могат ли да комуникират директно?

**Отговор:** НЕ - различни мрежи (`192.168.1.0` vs `192.168.2.0`), необходим е router

---

### Сценарий 2: Конфигуриране на default gateway

**Задача:** Конфигурирайте устройство със статичен IP

**Необходима информация:**
- IP адрес: `192.168.1.100`
- Subnet mask: `255.255.255.0`
- Default gateway: `192.168.1.1` (интерфейсът на router в тази мрежа)

**Резултат:** Устройството може да комуникира с локалната мрежа и чрез router с други мрежи

---

### Сценарий 3: Избор на топология

**Малка фирма (20 служители):**
- **Препоръка:** Един сегмент
- **Причина:** Прости нужди, ниска цена, достатъчна производителност

**Средна фирма (200 служители, 3 отдела):**
- **Препоръка:** Три сегмента (по един за отдел)
- **Причина:** Подобрена производителност, сигурност, организация

**Голяма фирма (1000+ служители, множество сгради):**
- **Препоръка:** Множество сегменти по местоположение и функция
- **Причина:** Мащабируемост, производителност, сигурност, управление
