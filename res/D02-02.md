# D02-02: Канален слой - Ethernet, капсулиране и комутация

**OSI Layer 2 - Data Link Layer**

---

## 1. Ethernet Frame

### Структура на рамката

**Ethernet = NIC-to-NIC комуникация на същата мрежа**

**Полета на Ethernet frame (в байтове):**

| Поле | Размер | Функция |
|------|--------|---------|
| **Preamble** | 7 bytes | Синхронизира приемащата NIC с битовете |
| **SFD** | 1 byte | Start Frame Delimiter - указва началото на frame |
| **Destination MAC** | 6 bytes | MAC адрес на дестинацията в мрежата |
| **Source MAC** | 6 bytes | MAC адрес на устройството, което е създало frame-а |
| **Type/Length** | 2 bytes | Тип протокол (0x800=IPv4, 0x86DD=IPv6, 0x806=ARP) или дължина |
| **Data** | 46-1500 bytes | Капсулираните данни (IPv4/IPv6 пакет, TCP/UDP, HTTP и пр.) |
| **FCS** | 4 bytes | Frame Check Sequence - проверка за грешки (CRC) |

### Размери

- **Минимум:** 64 bytes (от Destination MAC до FCS, без Preamble)
- **Максимум:** 1518 bytes
- **< 64 bytes** → "runt frame" / "collision fragment" → автоматично отхвърлен
- **> 1500 bytes data** → "jumbo frames" → поддържани от Fast/Gigabit Ethernet

### Детайли на полетата

**Preamble + SFD (8 bytes общо):**
- Използват се за синхронизация между изпращащо и приемащо устройство
- Първите 8 байта "събуждат" приемащите възли

**Destination MAC Address (6 bytes):**
- Идентификатор на получателя
- Layer 2 го използва за да определи дали frame-ът е адресиран към устройството
- Може да бъде unicast, multicast или broadcast

**Source MAC Address (6 bytes):**
- Идентифицира NIC/интерфейса, който е създал frame-а
- Винаги трябва да е unicast

**Type/Length (2 bytes):**
- Идентифицира горния слой протокол (EtherType)
- 0x800 (IPv4), 0x86DD (IPv6), 0x806 (ARP)

**Data (46-1500 bytes):**
- Съдържа капсулираните данни от горен слой
- Ако пакетът е малък, добавят се допълнителни битове (pad) до минимум 64 bytes

**Frame Check Sequence - FCS (4 bytes):**
- Cyclic Redundancy Check (CRC)
- Изпращащото устройство изчислява CRC и го поставя в FCS
- Приемащото устройство изчислява CRC и го сравнява
- Ако не съвпадат → frame-ът е изменен → отхвърля се

**Важно:** Ethernet не се интересува какви данни предава - просто ги доставя от NIC до NIC.

---

## 2. Капсулиране

### Разлика между Network и Ethernet Encapsulation

**Network Encapsulation (общо):**
- Целият процес на добавяне на headers на всички нива (L7→L1)
- Application → Transport → Network → Data Link → Physical
- Пълното "пакетиране" на данни през всички слоеве

**Ethernet Frame Encapsulation (специфично):**
- Само Layer 2 (Data Link) процесът
- Взема вече готов L3 пакет (IPv4/IPv6)
- "Опакова" го в Ethernet frame
- Добавя: Destination MAC, Source MAC, EtherType, FCS
- Работи само в локалната мрежа (NIC-to-NIC)

### Аналогия с писмото

Когато изпращаш писмо, използваш приет формат за да гарантираш, че писмото ще бъде доставено и разбрано от получателя. По същия начин съобщенията в компютърната мрежа следват специфични правила за формат.

**Процес:**
- **Encapsulation** - поставяне на едно съобщение (писмото) в друго (пликът)
- **De-encapsulation** - обратен процес, когато получателят отваря плика и вади писмото

Internet Protocol (IP) има функция подобна на плика - идентифицира източникът и дестинацията на пакета. IP е отговорен за изпращането на съобщението от източника до дестинацията през една или повече мрежи.

---

## 3. Комутация

### Как работят Ethernet комутаторите

**Layer 2 операция:**
Ethernet комутаторите работят на Layer 2 (Data Link) от OSI модела. Те взимат решения за препращане на базата на Layer 2 информация - Ethernet header информацията от Ethernet frame.

**MAC Address Table:**
Комутаторите имат MAC address таблици: MAC адрес → Порт

### Процес на изграждане на MAC таблица

**Примерна комуникация:**
```
H1 (AAAA) изпраща към H4 (DDDD)
```

**Първо изпращане (Unknown Unicast):**
```
Frame влиза на FA0/1
├─ LEARNING: Source MAC = AAAA
│   └─ НЕ е в таблицата → ДОБАВЯ: AAAA → FA0/1
└─ FORWARDING: Destination MAC = DDDD
    └─ НЕ е в таблицата → FLOODING (към всички портове)
```

Всички устройства получават frame-а:
- H2 и H3: MAC не съвпада → игнорират
- H4: MAC съвпада → приема frame-а

**Отговор:**
```
H4 отговаря към H1
Frame влиза на FA0/4
├─ LEARNING: Source MAC = DDDD
│   └─ НЕ е в таблицата → ДОБАВЯ: DDDD → FA0/4
└─ FORWARDING: Destination MAC = AAAA
    └─ Е в таблицата на FA0/1 → FILTERING (САМО към FA0/1)
```

**Следваща комуникация:**
```
H1 → H4 отново
├─ Source MAC = AAAA → вече е в таблицата
└─ Destination MAC = DDDD → вече е в таблицата на FA0/4
    └─ FILTERING към FA0/4 (не flooding!)
```

**Алгоритъм:**
1. **LEARNING** - проверява Source MAC, добавя/обновява в таблицата
2. **FORWARDING** - проверява Destination MAC:
   - В таблицата → **FILTERING** (изпраща към конкретен порт)
   - НЕ е в таблицата → **FLOODING** (изпраща към всички портове)
3. **AGING** - записите се пазят ~5 минути, след това се изтриват

---

## 4. Ethernet стандарти

### История

**Ранни дни:**
В началото всеки производител използваше свои собствени методи за свързване на мрежови устройства и протоколи. Оборудването от различни производители не работеше заедно.

**Предимства на стандартизацията:**
- Улеснява проектирането
- Опростява разработването на продукти
- Насърчава конкуренцията
- Осигурява консистентни връзки
- Улеснява обучението
- Повече избор за клиентите

**Ethernet като стандарт:**
Ethernet се превърна в **де факто стандарт** - технологията, използвана от почти всички локални мрежи.

### OSI модел и скорости

**Ethernet работи на два слоя:**
- Data Link Layer (Layer 2)
- Physical Layer (Layer 1)

**Стандарти:**
- IEEE 802.2 (LLC)
- IEEE 802.3 (MAC и Physical)

**Поддържани скорости:**
- 10 Mbps
- 100 Mbps
- 1 Gbps
- 10 Gbps
- 40 Gbps
- 100 Gbps

**Среди:**
- Twisted pair (усукани двойки)
- Fiber-optic (оптични кабели)
- Coaxial cables (коаксиални кабели)

---

## 5. Data Link подслоеве

IEEE 802 протоколите (включително Ethernet) използват **два отделни подслоя** на Data Link слоя:

### LLC (Logical Link Control) - IEEE 802.2
- Комуникира между мрежовия софтуер (горните слоеве) и хардуера (долните слоеве)
- Поставя информация във frame-а, която идентифицира кой Layer 3 протокол се използва
- Позволява множество Layer 3 протоколи (IPv4, IPv6) да използват един и същ мрежов интерфейс

### MAC (Media Access Control) - IEEE 802.3
- Имплементиран в **хардуер** (NIC)
- Отговорен за data encapsulation и media access control
- Осигурява Data Link layer адресиране
- Интегриран с различни Physical layer технологии

**Функции на MAC подслоя:**

**Data Encapsulation:**
- Ethernet frame структура
- Ethernet Addressing (source и destination MAC)
- Error Detection (FCS с CRC)

**Media Access:**
- Различни стандарти за мед и оптика
- Съвременните Ethernet LAN използват комутатори с full-duplex

---

## 6. MAC адресиране

### Шестнадесетична система

**Защо hex система?**
- IPv4 адреси → decimal (base 10)
- IPv6 адреси и Ethernet MAC → hexadecimal (base 16)

**Hexadecimal:**
- Използва цифри 0-9 и букви A-F
- 1 hex цифра = 4 binary бита
- MAC адрес = 48 бита = 12 hex цифри

**Основна hex таблица:**
```
Hex  Decimal  Binary
0    0        0000
5    5        0101
A    10       1010
F    15       1111
```

**Примери:**
- Binary: 0000 1010 = Hex: 0A = Decimal: 10
- Binary: 1111 1111 = Hex: FF = Decimal: 255
- 8 бита (1 byte): 00 to FF в hex

**Нотация:**
- `0x73` (с префикс 0x)
- `73H` (със суфикс H)

**Пример MAC адрес:** `00-1A-2B-3C-4D-5E`

---

## 7. Типове MAC адреси

### Unicast MAC адрес

**Unicast = уникален адрес за единично устройство**

**Характеристики:**
- 1 изпращач → 1 получател
- Source MAC винаги е unicast

**Пример:**
```
Host (192.168.1.5) → Server (192.168.1.200)
├─ Source IP: 192.168.1.5 (unicast)
├─ Destination IP: 192.168.1.200 (unicast)
├─ Source MAC: уникален MAC на host-а
└─ Destination MAC: уникален MAC на server-а
```

**Намиране на MAC адрес:**
- **ARP (Address Resolution Protocol)** - за IPv4
- **ND (Neighbor Discovery)** - за IPv6

---

### Broadcast MAC адрес

**Broadcast = FF-FF-FF-FF-FF-FF (48 единици)**

**Характеристики:**
- Получава се от **всяко устройство** в Ethernet LAN
- Switch изпраща към всички портове (flooding), освен входящия
- Рутерът **НЕ** го препраща

**Пример:**
```
Source: 192.168.1.5
Destination IP: 192.168.1.255 (broadcast)
Destination MAC: FF-FF-FF-FF-FF-FF
```

**Използване:**
- **DHCP заявки** - устройството няма IP адрес, затова изпраща broadcast
- **ARP заявки** - търсене на MAC адрес

**Важно:** Не всеки Ethernet broadcast съдържа IPv4 broadcast пакет. ARP заявките не използват IPv4, но се изпращат като Ethernet broadcast.

---

### Multicast MAC адрес

**Multicast = група от устройства**

**Характеристики:**
- Получава се от **група устройства** в LAN
- **IPv4 multicast:** MAC започва с `01-00-5E`
- **IPv6 multicast:** MAC започва с `33-33`
- Други multicast MAC: STP, LLDP

**Обработка:**
- Switch flooding (освен ако има multicast snooping)
- Рутерът **НЕ** го препраща (освен при multicast routing)

**Multicast IP адреси:**
- **IPv4:** 224.0.0.0 до 239.255.255.255
- **IPv6:** започва с ff00::/8
- Multicast адресите се използват **само като destination**

**Използване:**
- Routing протоколи (OSPF, EIGRP)
- Видео стрийминг
- STP, LLDP

---

## Обобщение

### Сравнение на MAC адреси

| Тип | MAC адрес | Получатели | Switch | Рутер |
|-----|-----------|------------|--------|-------|
| **Unicast** | Уникален | 1 устройство | Filtering | Препраща |
| **Broadcast** | FF-FF-FF-FF-FF-FF | Всички в LAN | Flooding | НЕ препраща |
| **Multicast** | 01-00-5E / 33-33 | Група | Flooding* | НЕ препраща* |

*освен ако има snooping/routing

---

### Ключови концепции

✅ **Ethernet Frame:**
- NIC-to-NIC комуникация
- 7 полета (Preamble, SFD, Dest MAC, Src MAC, Type, Data, FCS)
- 64-1518 bytes

✅ **Капсулиране:**
- Network Encapsulation = всички слоеве (L7→L1)
- Ethernet Encapsulation = само L2 слоя

✅ **Switch:**
- Learning (Source MAC → таблица)
- Forwarding (Filtering или Flooding)
- Aging (~5 минути)

✅ **MAC адреси:**
- Unicast (1:1, уникален)
- Broadcast (1:всички, FF-FF-FF-FF-FF-FF)
- Multicast (1:група, 01-00-5E / 33-33)

---

**Практика:** Wireshark за анализ на Ethernet frames и ARP трафик
