# IPv6 адресиране и IPv6 Header

---

## Проблеми с IPv4

### Необходимостта от IPv6

**IPv6 като заместник на IPv4:**
- IPv6 има по-голямо 128-битово адресно пространство
- Предоставя 340 undecillion (340 последвано от 36 нули) възможни адреси
- IPv6 е повече от просто по-големи адреси - включва подобрения и нови възможности

**Основни причини за преход към IPv6:**

**1. Изчерпване на IPv4 адресите**
- IPv4 има теоретичен максимум от 4.3 милиарда адреса
- 4 от 5-те RIR вече са изчерпали IPv4 адресите
- Частните адреси и NAT забавиха изчерпването, но не решават проблема дългосрочно

**2. Нарастване на интернет устройствата**
- Увеличаващ се брой мобилни устройства
- Водещите мобилни оператори в САЩ съобщават над 90% трафик през IPv6
- Топ ISP и доставчици на съдържание (YouTube, Facebook, Netflix) преминаха към IPv6

**3. Интернет на нещата (IoT)**
- Бъдещият интернет включва не само компютри, таблети и телефони
- Автомобили, биомедицински устройства, домакински уреди, екосистеми
- Сензори и устройства, готови за интернет

**Исторически контекст:**
В началото на 90-те години IETF се загрижи за проблемите с IPv4 и започна разработката на IPv6. IETF използва възможността да коригира ограниченията на IPv4 и да добави подобрения.

**Важна подробност:** ICMPv6 включва разрешаване на адреси и автоматично конфигуриране на адреси, което не се среща в ICMP за IPv4 (ICMPv4).

---

### Ограничения на IPv4

**Три основни проблема на IPv4:**

**1. Изчерпване на адресите**
- Ограничен брой уникални публични адреси (~4 милиарда)
- Нарастващ брой IP-съвместими устройства
- Постоянно активни връзки
- Потенциален растеж на по-слабо развитите региони

**2. Липса на цялостна свързаност (End-to-End Connectivity)**
- NAT скрива IPv4 адресите на вътрешни устройства
- Проблематично за технологии, изискващи директна свързаност
- Публичният IPv4 адрес се споделя между множество устройства

**3. Повишена мрежова сложност**
- NAT беше замислен само като преходен механизъм към IPv6
- Създава допълнителна сложност в мрежата
- Причинява латентност
- Затруднява отстраняването на проблеми

---

### Подобрения в IPv6

**Основни предимства:**

**1. Увеличено адресно пространство**
- 128-битова йерархична адресация (вместо 32-битова)
- 340,282,366,920,938,463,463,374,607,431,768,211,456 адреса
- Приблизително еквивалентно на всяка песъчинка на Земята

**2. Подобрена обработка на пакети**
- Опростена заглавна част с по-малко полета
- Фиксирана дължина от 40 байта (вместо променлива 20-60 байта)
- По-ефективна обработка на заглавките

**3. Елиминиране на нуждата от NAT**
- С голям брой публични IPv6 адреси, NAT не е необходим
- Избягва проблемите, предизвикани от NAT
- Цялостна свързаност за всички устройства

**Визуално сравнение:**
- IPv4: ~4.3 милиарда адреса
- IPv6: 340 undecillion адреса

---

## Съвместното съществуване на IPv4 и IPv6

**Реалност на прехода:**
Няма конкретна дата за преход към IPv6. IPv4 и IPv6 ще съществуват заедно в близкото бъдеще и преходът ще отнеме няколко години. IETF създаде различни протоколи и инструменти за помощ при миграцията.

**Три категории техники за миграция:**

### 1. Dual Stack (Двоен стек)

**Определение:** Позволява IPv4 и IPv6 да съществуват заедно в същия мрежов сегмент

**Как работи:**
- Устройствата работят едновременно с IPv4 и IPv6 протоколни стекове
- Известно като "native IPv6"
- Клиентската мрежа има IPv6 връзка към ISP
- Възможност за достъп до съдържание в интернет чрез IPv6

**Приложение:** Това е предпочитаният метод за преход

---

### 2. Tunneling (Тунелиране)

**Определение:** Метод за транспортиране на IPv6 пакет през IPv4 мрежа

**Как работи:**
- IPv6 пакетът се инкапсулира в IPv4 пакет
- Подобно на други видове данни
- Позволява IPv6 трафик да преминава през IPv4 инфраструктура

**Приложение:** Използва се временно, докато се изгради native IPv6

---

### 3. Translation (Преобразуване)

**NAT64:**
- Позволява на IPv6 устройства да комуникират с IPv4 устройства
- Използва техника за преобразуване, подобна на NAT за IPv4
- IPv6 пакет се преобразува в IPv4 пакет и обратно

**Важна забележка:** Tunneling и translation са за преход към native IPv6 и трябва да се използват само когато е необходимо. Целта трябва да бъде native IPv6 комуникация от източник до получател.

---

## Формати на IPv6 адресиране

### Шестнадесетична бройна система

**Основи:**
IPv6 адресите се представят с помощта на шестнадесетични числа (hexadecimal). Тази бройна система използва 16 символа:

```
0 1 2 3 4 5 6 7 8 9 A B C D E F
```

**Цел:** Позволява представяне на масивните 128-битови адреси в по-четлив формат

**Важно:** IPv6 адресите НЕ са чувствителни към регистър - могат да се пишат с малки или главни букви

---

### 16-битови сегменти или хекстети

**Структура на IPv6 адрес:**
- **Дължина:** 128 бита
- **Представяне:** Низ от шестнадесетични стойности
- Всеки 4 бита се представят от една шестнадесетична цифра
- **Общо:** 32 шестнадесетични стойности

**Пример:**
- Шестнадесетична цифра `2` = двоични битове `0010`
- Всеки 4 шестнадесетични цифри = 16 бита

**Hextet (Хекстет):**
- Неофициален термин за сегмент от 16 бита
- Всяко "x" е един hextet = 4 шестнадесетични цифри
- За сравнение: в IPv4 използваме термина "octet" за 8 бита

---

### Предпочитан формат

**Формат:** `x:x:x:x:x:x:x:x`

Където всяко "x" се състои от 4 шестнадесетични стойности, разделени с двоеточие.

**Примери в предпочитан формат:**
```
2001:0db8:0000:1111:0000:0000:0000:0200
2001:0db8:0001:0000:0000:0000:0000:0001
2001:0db8:85a3:0000:0000:8a2e:0370:7334
```

**Важно:** "Предпочитан формат" означава запис на всичките 32 шестнадесетични цифри. Не означава, че това е най-идеалният начин за представяне - има правила за съкращаване.

---

## Правила за форматиране на IPv6

### Правило 1: Изпускане на водещи нули

**Определение:** Всички водещи нули (leading zeros) в hextet могат да се изпуснат

**Важно:** Изпускат се САМО водещи нули, НЕ крайни нули (trailing zeros)

**Примери:**

**Пример 1:**
```
Оригинал:  01ab:0000:0000:0000:0000:0000:0000:0000
Правило 1:  1ab:   0:   0:   0:   0:   0:   0:   0
```

**Пример 2:**
```
Оригинал:  09f0:0000:0000:0000:0000:0000:0000:0000
Правило 1:  9f0:   0:   0:   0:   0:   0:   0:   0
```

**Пример 3:**
```
Оригинал:  0a00:0000:0000:0000:0000:0000:0000:0000
Правило 1:  a00:   0:   0:   0:   0:   0:   0:   0
(крайните нули НЕ се изпускат!)
```

**Защо само водещи нули?**
Ако изпускахме и водещи, и крайни нули, нямаше да знаем кои нули са били изпуснати.

---

### Правило 2: Двойно двоеточие за последователни нули

**Определение:** Всеки единичен непрекъснат низ от един или повече 16-битови сегмента, състоящи се изцяло от нули, може да се представи с двойно двоеточие `::`

**Как се прилага:**

**Стъпка 1:** Приложи Правило 1 (изпускане на водещи нули)
**Стъпка 2:** Приложи Правило 2 (двойно двоеточие за последователни нули)

**Пример 1:**
```
Оригинал:      2001:0db8:0000:0000:0000:0000:0000:0001
Правило 1:     2001: db8:   0:   0:   0:   0:   0:   1
Правило 2:     2001: db8::  1
Резултат:      2001:db8::1
```

**Пример 2:**
```
Оригинал:      2001:0db8:0000:0000:0000:0000:0000:0000
Правило 1:     2001: db8:   0:   0:   0:   0:   0:   0
Правило 2:     2001: db8::
Резултат:      2001:db8::
```
(Забележка: Всички нули в края са свързани с IPv6 мрежов адрес)

**Пример 3:**
```
Оригинал:      fe80:0000:0000:0000:0123:4567:89ab:cdef
Правило 1:     fe80:   0:   0:   0: 123:4567:89ab:cdef
Правило 2:     fe80:: 123:4567:89ab:cdef
Резултат:      fe80::123:4567:89ab:cdef
```

---

### Важни ограничения за Правило 2

**Ограничение 1: Само един път в адрес**
Двойното двоеточие `::` може да се използва **само веднъж** в адрес. Иначе биха имало повече от един възможен резултатен адрес.

**Неправилно:**
```
2001::25de::cade  ❌ (два пъти двойно двоеточие)
```

**Ограничение 2: При множество низове от нули**
Ако адресът има повече от един непрекъснат низ от нулеви hextet-и:
- **Най-добра практика:** Използвай `::` за **най-дългия** низ
- Приложи изпускане на водещи нули за по-късия низ
- Ако низовете са с еднаква дължина, използвай `::` за първия низ

**Пример:**
```
2001:0db8:0000:0000:0001:0000:0000:0001

Вариант 1: 2001:db8::1:0:0:1  (:: замества 4 нули)
Вариант 2: 2001:db8:0:0:1::1  (:: замества 3 нули)

Предпочитан: Вариант 1 (:: за по-дългия низ)
```

**Забележка:** Обикновено това е въпрос на лични предпочитания, стига да се спазват правилата.

---

## IPv6 пакет

### Сравнение на IPv4 и IPv6 заглавни части

**IPv4 Header:**
- Променлива дължина: 20-60 байта (с опции)
- 12 основни полета (без Options и Padding)
- По-сложна структура

**IPv6 Header:**
- Фиксирана дължина: 40 байта
- 8 полета (по-малко от IPv4)
- Опростена структура

**Основно подобрение:** Опростената IPv6 заглавна част позволява по-ефективна обработка

---

### Полета в IPv6 Header

**Структура на IPv6 пакет:**

**1. Version (Версия)** - 4 бита
- Двоична стойност: `0110` (идентифицира IPv6)
- Еквивалент на Version полето в IPv4

**2. Traffic Class (Клас на трафика)** - 8 бита
- Еквивалентно на IPv4 Differentiated Services (DS) поле
- Използва се за приоритизиране на пакети

**3. Flow Label (Етикет на потока)** - 20 бита
- Предполага, че всички пакети с един и същи етикет на потока получават еднакво обслужване от маршрутизаторите
- Нова функционалност в IPv6

**4. Payload Length (Дължина на полезния товар)** - 16 бита
- Показва дължината на данните или полезния товар на IPv6 пакета
- НЕ включва дължината на IPv6 заглавката (която е фиксирана - 40 байта)

**5. Next Header (Следваща заглавка)** - 8 бита
- Еквивалентно на IPv4 Protocol поле
- Показва типа на данните, които пакетът носи
- Позволява на мрежовия слой да предаде данните на съответния протокол от горния слой
- Може да показва и разширителни заглавки (Extension Headers)

**6. Hop Limit (Ограничение на скоковете)** - 8 бита
- Замества IPv4 TTL поле
- Стойността се намалява с 1 от всеки маршрутизатор
- При достигане на 0, пакетът се изхвърля
- Изпраща се ICMPv6 Time Exceeded съобщение до изходящото устройство

**Важна разлика от IPv4:** IPv6 НЕ включва Header Checksum, защото тази функция се извършва на по-долните и горните слоеве. Това означава, че контролната сума не трябва да се преизчислява от всеки маршрутизатор при намаляване на Hop Limit, което **подобрява производителността на мрежата**.

**7. Source IPv6 Address (Изходящ IPv6 адрес)** - 128 бита
- Идентифицира IPv6 адреса на изпращащото устройство

**8. Destination IPv6 Address (Целеви IPv6 адрес)** - 128 бита
- Идентифицира IPv6 адреса на получаващото устройство

---

### Extension Headers (Разширителни заглавки)

**Характеристики:**
- Опционални заглавки
- Поставят се между IPv6 заглавката и полезния товар
- Предоставят опционална информация на мрежовия слой

**Използване на разширителни заглавки:**
- Фрагментация (Fragmentation)
- Сигурност (Security)
- Поддръжка на мобилност (Mobility)
- И други специфични функции

**Важна разлика:** За разлика от IPv4, маршрутизаторите **НЕ фрагментират** маршрутизирани IPv6 пакети. Фрагментацията в IPv6 се извършва само от изходящото устройство.

---

### Полета от IPv4, които се запазват, променят или премахват

**Запазени полета:**
- Version (сменено от 4 на 6)
- Source Address / Destination Address (разширени до 128 бита)
- Traffic Class (бивше DS/ToS поле)

**Преименувани/Променени полета:**
- TTL → Hop Limit
- Protocol → Next Header
- Няма Header Checksum (функцията се извършва другаде)

**Премахнати полета от IPv4:**
- Header Length (фиксирана дължина в IPv6)
- Identification, Flags, Fragment Offset (фрагментацията се управлява различно)
- Options (заменени с Extension Headers)

---

## IPv6 в реалността

### Текущо състояние на внедряването (2025)

**Глобално:**
- Големите доставчици (Google, Facebook, YouTube, Netflix) вече работят с IPv6
- Мобилните оператори в много държави дават IPv6 адреси по подразбиране
- Големи хостинг компании и CDN (Cloudflare, Akamai) предлагат пълна IPv6 поддръжка
- Водещи мобилни оператори в САЩ: над 90% трафик през IPv6
- Comcast (2018): над 65% внедряване
- British Sky Broadcasting: над 86% внедряване

**България (RIPE NCC регион):**
- България е в средата на класацията
- IPv4 официално свърши през ноември 2019 в региона на RIPE NCC
- Някои доставчици поддържат IPv6
- Много фирми и домашни мрежи все още разчитат основно на IPv4
- Нови IPv4 адреси се купуват на вторичен пазар (~30-60 USD на адрес)

**Разпределение на адреси:**
- **IANA** управлява и разпределя IP адреси
- **5 RIR (Regional Internet Registries):**
  - ARIN - Северна Америка
  - RIPE NCC - Европа, Близкия изток и Централна Азия (включително България)
  - APNIC - Азия и Тихоокеански регион
  - LACNIC - Латинска Америка и Карибски регион
  - AFRINIC - Африка

---

### Защо преходът е бавен?

**Технически причини:**
- Много стари маршрутизатори и устройства нямат пълна IPv6 поддръжка
- IPv4 все още работи чрез NAT - няма силен натиск за незабавен преход
- Миграцията изисква промени в инфраструктурата - време и средства

**Бизнес фактори:**
- Работещи IPv4 решения с NAT
- Разходи за обновление на оборудване
- Обучение на персонал

---

### Прогноза за бъдещето

**Следващи 5-10 години:**
- IPv6 ще стане стандартен протокол в мобилните и новите фиксирани мрежи
- IPv4 ще остане в т.нар. "dual stack" режим (IPv4 + IPv6 едновременно)
- Когато ресурсите за IPv4 станат твърде ограничени и NAT стане проблем, преходът ще се ускори

**Тестване на IPv6 поддръжка:**
Можете да проверите дали вашият доставчик и устройство работят с IPv6 на: https://test-ipv6.com/

---

## Въпроси за самопроверка

1. Колко бита е дълъг IPv6 адресът?
2. Защо е необходим преходът към IPv6?
3. Какви са трите техники за съвместно съществуване на IPv4 и IPv6?
4. Каква е разликата между "предпочитан формат" и "съкратен формат" на IPv6 адрес?
5. Какво представлява hextet в IPv6?
6. Кои са двете правила за форматиране на IPv6 адреси?
7. Колко пъти може да се използва двойно двоеточие `::` в един IPv6 адрес?
8. Каква е дължината на IPv6 заглавната част?
9. Кое IPv4 поле е заменено от Hop Limit в IPv6?
10. Защо IPv6 НЕ включва Header Checksum поле?
11. Какво представляват Extension Headers в IPv6?
12. Кой фрагментира IPv6 пакети - маршрутизаторите или изходящото устройство?

---

## Основни термини за запомняне

- **IPv6** - Интернет протокол версия 6 със 128-битови адреси
- **Hexadecimal (Шестнадесетична система)** - бройна система с 16 цифри (0-9, A-F)
- **Hextet** - 16-битов сегмент в IPv6 адрес (4 шестнадесетични цифри)
- **Предпочитан формат** - запис на всичките 32 шестнадесетични цифри
- **Съкратен формат** - IPv6 адрес след прилагане на правилата за форматиране
- **Dual Stack** - устройство, работещо едновременно с IPv4 и IPv6
- **Tunneling** - инкапсулация на IPv6 пакет в IPv4 пакет
- **NAT64** - преобразуване между IPv6 и IPv4 пакети
- **Native IPv6** - директна IPv6 връзка без tunneling или translation
- **Flow Label** - етикет на потока в IPv6 за еднакво обслужване
- **Hop Limit** - IPv6 еквивалент на TTL
- **Extension Headers** - опционални заглавки в IPv6 пакет
- **RIR** - Regional Internet Registry (регионален интернет регистър)
- **IoT** - Internet of Things (Интернет на нещата)
- **Undecillion** - 1 последвано от 36 нули

---

## Ключови числа за запомняне

- IPv4: 32 бита, ~4.3 милиарда адреса
- IPv6: 128 бита, 340 undecillion адреса
- IPv4 Header: 20-60 байта (променлива дължина)
- IPv6 Header: 40 байта (фиксирана дължина)
- IPv6 адрес: 8 хекстета, всеки по 16 бита
- Шестнадесетична система: 16 символа (0-9, A-F)
- 4 RIR от 5 са изчерпали IPv4 адресите
- Над 90% мобилен трафик в САЩ е през IPv6


<script data-goatcounter="https://satanasov.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>

<script src="/SNA/assets/js/analytics-logger.js"></script>
